<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bluejay  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Bluejay  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Bluejay Docs</a> (43% documented)</p>
        <p class="header-right"><a href="https://github.com/steamclock/bluejay"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Bluejay Reference</a>
        <img id="carat" src="img/carat.png" />
        Bluejay  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Bluejay.html">Bluejay</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Peripheral.html">Peripheral</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SynchronizedPeripheral.html">SynchronizedPeripheral</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/BackgroundRestoreMode.html">BackgroundRestoreMode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ConnectionResult.html">ConnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DisconnectionResult.html">DisconnectionResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/DiscoveryResult.html">DiscoveryResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ListenAction.html">ListenAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ReadResult.html">ReadResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RunResult.html">RunResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/ScanAction.html">ScanAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/WriteResult.html">WriteResult</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/CBManagerState.html">CBManagerState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheral.html">CBPeripheral</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBPeripheralState.html">CBPeripheralState</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/CBService.html">CBService</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Data.html">Data</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Integer.html">Integer</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/Notification.html">Notification</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/String.html">String</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/ConnectionObserver.html">ConnectionObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ListenRestorer.html">ListenRestorer</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RSSIObserver.html">RSSIObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Receivable.html">Receivable</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Sendable.html">Sendable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/CharacteristicIdentifier.html">CharacteristicIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DataPadding.html">DataPadding</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PeripheralIdentifier.html">PeripheralIdentifier</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ScanDiscovery.html">ScanDiscovery</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ServiceIdentifier.html">ServiceIdentifier</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <p><img src="bluejay-wordmark.png" alt="Bluejay"></p>

<p>Bluejay is a simple Swift framework for building reliable Bluetooth LE apps.</p>

<p>Bluejay&rsquo;s primary goals are:</p>

<ul>
<li>Simplify talking to a single Bluetooth LE peripheral</li>
<li>Make it easier to handle Bluetooth LE operations reliably</li>
<li>Make good use of Swift features and conventions</li>
</ul>
<h2 id='features' class='heading'>Features</h2>

<ul>
<li>A callback-based API that can be more pleasant to work with than delegation in most cases</li>
<li>A FIFO operation queue that allows more synchronous and predictable behaviours</li>
<li>A background task mode to perform batch operations and avoid callback pyramids of death</li>
<li>Simple protocols for data serialization and deserialization</li>
<li>Easy and safe observation of Bluetooth and connection states</li>
<li>Listen restoration</li>
<li>Extended error handling</li>
</ul>
<h2 id='requirements' class='heading'>Requirements</h2>

<ul>
<li>iOS 10 or above</li>
<li>Xcode 8.2.1 or above</li>
<li>Swift 3.2 or above</li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>

<p>Install using CocoaPods:</p>

<p><code>pod &#39;Bluejay&#39;, :git =&gt; &#39;https://github.com/steamclock/bluejay.git&#39;, :branch =&gt; &#39;master&#39;</code></p>

<p>Import using:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Bluejay</span>
</code></pre>
<h2 id='demo' class='heading'>Demo</h2>

<p>The Simulator does not simulate Bluetooth, and you may also not have access to a configurable Bluetooth LE peripheral right away, so we recommend trying Bluejay using a virtual BLE peripheral that can be set up using the <a href="https://itunes.apple.com/ca/app/lightblue-explorer-bluetooth/id557428110?mt=8">LightBlue Explorer</a> app you can download for free from the App Store.</p>

<p>Bluejay has a demo app called <strong>BluejayDemo</strong> that works with LightBlue Explorer, and to see it in action:</p>

<ol>
<li>Prepare two iOS devices â€“ one will act as a virtual BLE peripheral, and the other will run the demo app which demonstrates how Bluejay can be used.</li>
<li>On the iOS device serving as the virtual BLE peripheral, go to the App Store and download LightBlue Explorer.</li>
<li>Launch LightBlue Explorer, and tap on the <strong>Create Virtual Peripheral</strong> button located at the bottom of the peripheral list.</li>
<li>For simplicity, choose <strong>Heart Rate</strong> from the base profile list, and finish by tapping the <strong>Save</strong> button.</li>
<li>Finally, build and run the <strong>BluejayDemo</strong> on the other iOS device, choose <strong>Heart Rate Sensor</strong> in the menu, and you will be able to start interacting with the virtual heart rate peripheral.</li>
</ol>

<p><strong>Notes:</strong></p>

<ul>
<li>You can turn the virtual peripheral on or off in LightBlue Explorer by tapping the blue circle to the left of the peripheral&rsquo;s name.

<ul>
<li>If the virtual peripheral is not working as expected, you can try to reset it this way.</li>
</ul></li>
<li>The virtual peripheral may use your iPhone or iPad name, because the virtual peripheral is an extension of the host device.</li>
</ul>
<h2 id='usage' class='heading'>Usage</h2>
<h3 id='initialization' class='heading'>Initialization</h3>

<p>Create an instance of Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">bluejay</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="p">()</span>
</code></pre>

<p>Depending on the nature of your app, you may want to create one single instance and use it throughout, or create one in a specific portion of your app and tear it down after use. Either way, the important thing to note here is that each instance of Bluejay has its own <a href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanager">CBCentralManager</a>, and initializing Bluejay doesn&rsquo;t start the <a href="https://developer.apple.com/documentation/corebluetooth">Core Bluetooth</a> session just yet.</p>

<p>Start Bluejay during initialization of your app or view controller, as appropriate. For example, in the demo app Bluejay is started inside <code>viewDidLoad</code> of the root view controller.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>

<p>Bluejay needs to be started explicitly because in order to support listen restoration properly in a block-based API, we need to make sure the necessary objects are initialized and available before the Core Bluetooth stack is restored from the background.</p>

<p>However, state restoration is disabled by default in Bluejay. <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html#//apple_ref/doc/uid/TP40013257-CH7-SW1">Background mode</a> and <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html#//apple_ref/doc/uid/TP40013257-CH7-SW10">state restoration</a> are slightly complicated features, but important for apps that need to work in the background.</p>
<h3 id='background-mode' class='heading'>Background Mode</h3>

<p>In order to support background mode, make sure to turn on the <strong>Background Modes</strong> capability in your Xcode project with <strong>Uses Bluetooth LE accessories</strong> enabled.</p>

<p>Enabling background mode doesn&rsquo;t enable state restoration. State restoration is an additional behaviour on top of background mode that requires another step to setup.</p>
<h3 id='state-restoration' class='heading'>State Restoration</h3>

<p>Once your project has BLE accessories background mode enabled, you can choose to opt-in to state restoration when you start your Bluejay session.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">backgroundRestore</span><span class="p">:</span> <span class="o">.</span><span class="nf">enable</span><span class="p">(</span><span class="n">yourRestoreIdentifier</span><span class="p">))</span>
</code></pre>

<p>Additionally, Bluejay even allows you to restore listen callbacks on subscribed characteristics that did not end when the app has stopped running.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">backgroundRestore</span><span class="p">:</span> <span class="o">.</span><span class="nf">enable</span><span class="p">(</span><span class="n">yourRestoreIdentifier</span><span class="p">,</span> <span class="n">yourListenRestorer</span><span class="p">))</span>
</code></pre>
<h3 id='listen-restoration' class='heading'>Listen Restoration</h3>

<p>If state restoration is enabled and your app has stopped running either due to memory pressure or by staying in the background past the allowed duration (3 minutes since iOS 7), then the next time your app is launched in the background or foreground, Bluejay will call the <code>willRestoreListen</code> function on your <code>ListenRestorer</code> during state restoration if there are any active listens preserved.</p>

<p>The listen restorer protocol:</p>
<pre class="highlight swift"><code><span class="cm">/**
    A class protocol allowing notification of a characteristic being listened on, and provides an opportunity to restore its listen callback during Bluetooth state restoration.

    Bluetooth state restoration occurs when the background mode capability is turned on, and if the app is backgrounded or even terminated while a Bluetooth operation is still ongoing, iOS may keep the Bluetooth state alive, and attempt to restore it on resuming the app, so that the connection and operation between the app and the Bluetooth accessory is not interrupted and severed.
*/</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ListenRestorer</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="cm">/**
        Notify the conforming class that there is a characteristic being listened on, but it doesn't have any listen callbacks.

        - Note: Use the function `restoreListen` in Bluejay to restore the desired callback for the given characteristic and return true. Return false to prevent restoration, as well as to cancel the listening on the given characteristic.

        - Parameter on: the characterstic that is still being listened on when the CoreBluetooth stack is restored in the app.
        - Return: true if the characteristic's listen callback will be restored, false if the characteristic's listen should be cancelled and not restored.
    */</span>
    <span class="kd">func</span> <span class="nf">willRestoreListen</span><span class="p">(</span><span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span>
</code></pre>

<p>By default, if there is no <code>ListenRestorer</code> delegate provided in the <code>start</code> function, then Bluejay will cancel <strong>all</strong> active listens during state restoration.</p>

<p>Example:</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">ListenRestorer</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">willRestoreListen</span><span class="p">(</span><span class="n">on</span> <span class="nv">characteristic</span><span class="p">:</span> <span class="kt">CharacteristicIdentifier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">characteristic</span> <span class="o">==</span> <span class="n">heartRate</span> <span class="p">{</span>
            <span class="n">bluejay</span><span class="o">.</span><span class="nf">restoreListen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRate</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Listen succeeded with value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Listen failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>

            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<h3 id='bluetooth-events' class='heading'>Bluetooth Events</h3>

<p>The <code>ConnectionObserver</code> protocol allows your class to monitor and respond to major Bluetooth and connection-related events:</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ConnectionObserver</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">bluetoothAvailable</span><span class="p">(</span><span class="n">_</span> <span class="nv">available</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">connected</span><span class="p">(</span><span class="n">_</span> <span class="nv">peripheral</span><span class="p">:</span> <span class="kt">Peripheral</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">disconected</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>

<p>You can register an observer when starting Bluejay:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">connectionObserver</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
</code></pre>

<p>Or you can add additional observers later using:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">observer</span><span class="p">:</span> <span class="n">batteryLabel</span><span class="p">)</span>
</code></pre>

<p>Unregistering an observer is not necessary, because Bluejay only holds weak references to registered observers. But if you require unregistering an observer explicitly, you can:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">unregister</span><span class="p">(</span><span class="nv">observer</span><span class="p">:</span> <span class="n">rssiLabel</span><span class="p">)</span>
</code></pre>
<h3 id='services-amp-characteristics' class='heading'>Services &amp; Characteristics</h3>

<p>In Bluetooth parlance, a Service is a group of attributes, and a Characteristic is an attribute belonging to a category. For example, BLE peripherals that can detect heart rates usually have a Service named <q>Heart Rate</q> with a UUID of <q>180D</q>. Inside that Service are Characteristics such as <q>Body Sensor Location</q> with a UUID of <q>2A38</q>, as well as <q>Heart Rate Measurement</q> with a UUID of <q>2A37</q>.</p>

<p>Many of these Services and Characteristics are standards specified by the Bluetooth SIG organization, and most hardware adopt their specifications. For example, most BLE peripherals have the Service <q>Device Information</q> with a UUID of <q>180A</q>, where Characteristics such as firmware version, serial number, and other hardware details can be read and written. Of course, there are many BLE uses not covered by the Bluetooth Core Spec, and custom hardware often have their own unique Services and Characteristics.</p>

<p>Here is how you can specify Services and Characteristics for use in Bluejay:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">heartRateService</span> <span class="o">=</span> <span class="kt">ServiceIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"180D"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bodySensorLocation</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A38"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">heartRate</span> <span class="o">=</span> <span class="kt">CharacteristicIdentifier</span><span class="p">(</span><span class="nv">uuid</span><span class="p">:</span> <span class="s">"2A37"</span><span class="p">,</span> <span class="nv">service</span><span class="p">:</span> <span class="n">heartRateService</span><span class="p">)</span>
</code></pre>

<p>Bluejay requires using the <code>ServiceIdentifier</code> and <code>CharacteristicIdentifier</code> structs because this can help make it clear in your code whether you are working with a Service or a Characteristic, and prevents problems like mistakingly using or specifying a Service when a Characteristic is expected.</p>
<h3 id='scanning' class='heading'>Scanning</h3>

<p>Bluejay has a powerful scanning API that can be either simple or customizable to satisfy many use cases.</p>
<h4 id='basic-scanning' class='heading'>Basic Scanning</h4>

<p>This simple call will just notify you when there is a new discovery, and when the scan has finished:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="p">[</span><span class="n">heartRateService</span><span class="p">],</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">stopped</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>A scan result <code>(ScanDiscovery, [ScanDiscovery])</code> is represented by the current discovery followed by an array of all the discoveries made so far.</p>

<p>The stopped result contains all the discoveries made, and an error if there is one.</p>
<h4 id='scan-action' class='heading'>Scan Action</h4>

<p>Note how a <code>ScanAction</code> is returned at the end of a discovery callback to tell Bluejay whether to keep scanning or to stop.</p>
<pre class="highlight swift"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ScanAction</span> <span class="p">{</span>
    <span class="k">case</span> <span class="err">`</span><span class="k">continue</span><span class="err">`</span>
    <span class="k">case</span> <span class="n">blacklist</span>
    <span class="k">case</span> <span class="n">stop</span>
    <span class="k">case</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">ScanDiscovery</span><span class="p">,</span> <span class="p">(</span><span class="kt">ConnectionResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Returning <code>blacklist</code> will ignore any future discovery of the same peripheral within the current scan session, and is only useful when <code>allowDuplicates</code> is set to true, as that is the only way to rediscover the same peripheral.</p>

<p>Returning <code>connect</code> will first stop the current scan, then Bluejay will make your connection request. This is useful if you want to connect right away when you&rsquo;ve found the peripheral you&rsquo;re looking for. You can setup the <code>ConnectionResult</code> block outside the scan call to minimize nested callbacks.</p>
<h4 id='monitoring' class='heading'>Monitoring</h4>

<p>Another useful way to use the scan API, for example, is to monitor the RSSI changes of nearby peripherals to predict their proximity:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">scan</span><span class="p">(</span>
    <span class="nv">allowDuplicates</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nv">serviceIdentifiers</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">discovery</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">discovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
    <span class="p">},</span>
    <span class="nv">expired</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">lostDiscovery</span><span class="p">,</span> <span class="n">discoveries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ScanAction</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="n">stop</span>
    <span class="p">}</span>

    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Lost discovery: </span><span class="se">\(</span><span class="n">lostDiscovery</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">discoveries</span>
    <span class="n">weakSelf</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>

    <span class="k">return</span> <span class="o">.</span><span class="k">continue</span>
<span class="p">})</span> <span class="p">{</span> <span class="p">(</span><span class="n">discoveries</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Scan stopped without error."</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The two key new parameters specified here are: <code>allowDuplicates</code> and <code>expired</code>.</p>

<p>Setting <code>allowDuplicates</code> to true will stop coalescing multiple discoveries of the same peripheral into one single discovery callback, instead, you&rsquo;ll get a discovery every time a peripheral&rsquo;s advertising packet is picked up. This will consume more battery, and does not work in the background.</p>

<p>The <code>expired</code> callback is only invoked when <code>allowDuplicates</code> is true, and is still optional even with <code>allowDuplicates</code> enabled. This is Bluejay&rsquo;s best guess at when a previously discovered peripheral might be out of range, or no longer broadcasting. Essentially, when <code>allowDuplicates</code> is set to true, every time a peripheral is discovered a long timer associated with that peripheral starts counting down. If that peripheral is within range, and even if it has the slowest broadcasting interval, it is likely that peripheral will be picked up by Core Bluetooth again and causes the timer to refresh. If not, it&rsquo;s somewhat safe to assume it is gone. Use this with caution.</p>

<p>Finally, setting the service identifiers to nil will result in picking up all available Bluetooth peripherals in the vicinity. This also consumes more battery, and again, does not work in the background.</p>
<h3 id='connecting' class='heading'>Connecting</h3>

<p>It is important to keep in mind that Bluejay is designed to work with a single BLE peripheral, so multiple connection is not currently supported, and a connection request will fail if Bluejay is already connected or is still connecting. Although this can be a limitation, it is also a safeguard to ensure your app does not issue connection unnecessarily or erroneously.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">peripheralIdentifier</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">peripheral</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> successful."</span><span class="p">)</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="n">weakSelf</span><span class="o">.</span><span class="nf">performSegue</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="s">"showHeartSensor"</span><span class="p">,</span> <span class="nv">sender</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Connection to </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>To disconnect:</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
</code></pre>

<p>Albeit rarely, a disconnect request can still fail or get cancelled, so it is generally a good idea to make use of the completion block to provide error handling.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="n">disconnect</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">peripheral</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s"> successful."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheralIdentifier</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuidString</span><span class="se">)</span><span class="s"> cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Disconnection from </span><span class="se">\(</span><span class="n">peripheralIdentifier</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuidString</span><span class="se">)</span><span class="s"> failed with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='connection-states' class='heading'>Connection States</h4>

<p>Your Bluejay instance has these properties to help you make connection-related decisions:</p>

<ul>
<li><code>isBluetoothAvailable</code></li>
<li><code>isConnecting</code></li>
<li><code>isConnected</code></li>
<li><code>isDisconnecting</code></li>
<li><code>isScanning</code></li>
</ul>
<h2 id='deserialization-amp-serialization' class='heading'>Deserialization &amp; Serialization</h2>

<p>Reading, writing, and listening to Characteristics are straight-forward in Bluejay. Instead, you will be spending most of your time building out the deserialization and serialization of data that will be used in the aforemetioned interactions. So let&rsquo;s have a quick look at how Bluejay helps make this process standardized in your app via the <code>Receivable</code> and <code>Sendable</code> protocols.</p>
<h4 id='receivable' class='heading'>Receivable</h4>

<p>The models that represent data you wish to read and receive from your peripheral should all conform to the <code>Receivable</code> protocol.</p>

<p>Here is a partial example for the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml">Heart Rate Measurement Characteristic</a>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">HeartRateMeasurement</span><span class="p">:</span> <span class="kt">Receivable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement8bits</span><span class="p">:</span> <span class="kt">UInt8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">measurement16bits</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">energyExpended</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">rrInterval</span><span class="p">:</span> <span class="kt">UInt16</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">isMeasurementIn8bits</span> <span class="o">=</span> <span class="kc">true</span>

    <span class="k">var</span> <span class="nv">measurement</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">isMeasurementIn8bits</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement8bits</span><span class="p">)</span> <span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">measurement16bits</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">bluetoothData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">isMeasurementIn8bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mb">0b00000001</span><span class="p">)</span> <span class="o">==</span> <span class="mb">0b00000000</span>

        <span class="k">if</span> <span class="n">isMeasurementIn8bits</span> <span class="p">{</span>
            <span class="n">measurement8bits</span> <span class="o">=</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">measurement16bits</span> <span class="o">=</span> <span class="n">bluetoothData</span><span class="o">.</span><span class="nf">extract</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>Note how you can use the <code>extract</code> function extended upon <code>Data</code> that is built into Bluejay to easily parse the bytes you need. We have plans to build more protection and error handling for this in the near future.</p>

<p>Finally, while it is not essential and it will also depend on the context as well, we recommend only exposing the needed and computed properties of your models.</p>
<h4 id='sendable' class='heading'>Sendable</h4>

<p>The models representing data you wish to send to your peripheral should all conform to the <code>Sendable</code> protocol.</p>

<p>In a nut shell, help Bluejay figure out how to convert your models into <code>Data</code>:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">WriteRequest</span><span class="p">:</span> <span class="kt">Sendable</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">handle</span><span class="p">:</span> <span class="kt">UInt16</span>
    <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Sendable</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">handle</span><span class="p">:</span> <span class="kt">UInt16</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Sendable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="k">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">toBluetoothData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Data</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">startByte</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x3A</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">payloadLength</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="nf">toBluetoothData</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
        <span class="k">let</span> <span class="nv">command</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">handleInBigEndian</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">bigEndian</span>

        <span class="k">let</span> <span class="nv">crc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">Bluejay</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">sendables</span><span class="p">:</span> <span class="p">[</span><span class="n">command</span><span class="p">,</span> <span class="n">handleInBigEndian</span><span class="p">,</span> <span class="n">data</span><span class="p">])</span> <span class="k">as</span> <span class="kt">NSData</span><span class="p">)</span><span class="o">.</span><span class="n">crc16CCITT</span>

        <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">Bluejay</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">sendables</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">startByte</span><span class="p">,</span>
            <span class="n">payloadLength</span><span class="p">,</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">handleInBigEndian</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">crc</span><span class="o">.</span><span class="n">bigEndian</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="n">request</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>Note how we have a nested <code>Sendable</code> in this slightly more complicated model, as well as making use of the <code>combine</code> helper function to group and to arrange the data bytes in a particular order.</p>
<h2 id='interactions' class='heading'>Interactions</h2>

<p>Once you have your data modelled using either the <code>Receivable</code> or <code>Sendable</code> protocol, the read, write, and listen API in Bluejay will handle the deserialization and serialization seamlessly for you. All you need to do is to specify the type for the generic result wrappers, <code>ReadResult&lt;T&gt;</code> or <code>WriteResult&lt;T&gt;</code>.</p>
<h3 id='reading' class='heading'>Reading</h3>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">firmwareVersion</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">FirmwareVersion</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">firmwareVersion</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">firmwareVersion</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Read to firmware version cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to read firmware version with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='writing' class='heading'>Writing</h3>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">nickname</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">newNickname</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">WriteResult</span><span class="o">&lt;</span><span class="kt">Nickname</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Write to nickanme successful."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Write to nickname cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to write to nickname with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='listening' class='heading'>Listening</h3>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">listen</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">heartRateMeasurement</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">ReadResult</span><span class="o">&lt;</span><span class="kt">HeartRateMeasurement</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">weakSelf</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">heartRateMeasurement</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">heartRateMeasurement</span><span class="o">.</span><span class="n">measurement</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Listen to heart rate measurement cancelled."</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to listen to heart rate measurement with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='batch-operations' class='heading'>Batch Operations</h3>

<p>Often, your app needs to perform a series of reads, writes, and listens to complete a specific task, such as syncing, upgrading to a new firmware, or working with a notification-based Bluetooth module. In these cases, Bluejay provides an API for running all your operations on a background thread, and will call completion back on the main thread when either everything finishes without an error, or if one of the operations has failed.</p>
<pre class="highlight swift"><code><span class="n">bluejay</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="nv">backgroundTask</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">peripheral</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">var</span> <span class="nv">responseCode</span><span class="p">:</span> <span class="kt">ResponseCode</span><span class="p">?</span>

        <span class="k">try</span> <span class="n">peripheral</span><span class="o">.</span><span class="nf">writeAndListen</span><span class="p">(</span>
            <span class="nv">writeTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoTX</span><span class="p">,</span>
            <span class="nv">value</span><span class="p">:</span> <span class="kt">WriteRequest</span><span class="p">(</span><span class="nv">handle</span><span class="p">:</span> <span class="kt">Registers</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">motionControlEnable</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="n">enabled</span> <span class="p">?</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
            <span class="nv">listenTo</span><span class="p">:</span> <span class="kt">Characteristics</span><span class="o">.</span><span class="n">rigadoRX</span><span class="p">,</span>
            <span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">WriteResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ListenAction</span> <span class="k">in</span>
                <span class="n">responseCode</span> <span class="o">=</span> <span class="kt">ResponseCode</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">responseCode</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">.</span><span class="n">done</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">responseCode</span> <span class="o">!=</span> <span class="o">.</span><span class="n">ok</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">NSError</span><span class="p">(</span><span class="nv">domain</span><span class="p">:</span> <span class="s">"MyApp"</span><span class="p">,</span> <span class="nv">code</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">userInfo</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSLocalizedDescriptionKey</span> <span class="p">:</span> <span class="s">"Failed writing to motion control enable."</span><span class="p">])</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="nv">completionOnMainThread</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Motion control enable changed to: </span><span class="se">\(</span><span class="n">enabled</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>            
        <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Change motion control enable cancelled."</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="nf">debugPrint</span><span class="p">(</span><span class="s">"Failed to change motion control enable with error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre>

<p>The key here is that when performing your Bluetooth operations in the background, you <strong>must</strong> use the <code>SynchronizedPeripheral</code> given to you by this API. <strong>DO NOT</strong> call any <code>bluejay</code>.<code>read/write/listen</code> functions inside the <code>backgroundTask</code> block.</p>
<h2 id='documentaion' class='heading'>Documentaion</h2>

<p><a href="https://steamclock.github.io/bluejay/index.html">https://steamclock.github.io/bluejay/index.html</a></p>

          </section>
        </section>
        <section id="footer">
          <p>Copyright Â© 2017 Steamclock Software. All rights reserved.</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy â™ªâ™« v0.8.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
